<!doctype html>
<!--[if lt IE 7 ]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>Cubes</title>        
  <meta name="description" content="">
  <meta name="author" content="Angel Hackers">
  <link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><!-- CSS : implied media="all" -->
  <link rel="stylesheet" href="css/style.css?v=1">
  <link rel="stylesheet" href="css/override.css"> 
  <!-- All JavaScript at the bottom, except for Modernizr which enables HTML5 elements & feature detects -->
  <script src="js/libs/modernizr-1.7.min.js"></script>
  <!-- Grab Google CDN jQuery. fall back to local if necessary -->
          <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
          <script>window.jQuery || document.write("<script src='js/libs/jquery-1.8.3.min.js'>\x3C/script>")</script>

          <script src="js/libs/plugins.js?v=1"></script>
          <!--[if lt IE 7 ]>
            <script src="js/dd_belatedpng.js?v=1"></script>
          <![endif]--> 
  <style type="text/css">
        #webcam, #back {
            display: none;
            position: absolute;
            top:40;
            left:0;
        }
        #front {
            position:absolute;
            top:40;
            left:0;
        }
    </style>
  </head>
    <body>        
        <div id="log">
            Decoded frames: 0 Avg: 0<br>
            Dropped frames: 0 Avg: 0<br>
        </div>  
        <div id="color"></div>
        <video id="webcam" width="320" height="240"></video>

        <canvas id="back" width="320" height="240"></canvas>
        <canvas id="front" width="320" height="240"></canvas>

        <script type="text/javascript" src="js/BlobDetector.js"></script>
        <script type="text/javascript" src="js/Cv.js"></script>
        <script type="text/javascript" src="js/Stats.js"></script>

        <script type="text/javascript">
            //GetUserMedia
            window.URL = window.URL || window.webkitURL;
            navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;

            var video = document.querySelector('video');
            var Stats = new Stats(video);
            if (navigator.getUserMedia) {
                navigator.getUserMedia({audio: false, video: true}, function(stream) {
                    Stats.startTest(window.URL.createObjectURL(stream));
                }, function fail () {
                    console.log('you fail');
                });
            }
            window.requestAnimFrame = (function(){
                return  window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function( callback ){
                        window.setTimeout(canvasllback, 1000 / 60);
                    };
            })();

            //Init
            var canvas = document.getElementById('front');
            var ctx = canvas.getContext('2d');
            var backCanvas = document.getElementById('back');
            var backCtx = backCanvas.getContext('2d');

            var Cv = new Cv(backCanvas);
            var BlobDetector = new BlobDetector(Cv, backCanvas);

            var mousex = mousey = 0;
            var offset = $(canvas).offset();
            var colorDiv = document.getElementById('color');
            $(canvas).mousemove(function(e){
                mousex = Math.floor(e.pageX - offset.left);
                mousey = Math.floor(e.pageY - offset.top);
                colorStr = BlobDetector.getPixelColor(backCtx, mousex, mousey);
                colorDiv.innerHTML = colorStr;
            });

            function getVideoFrame() {
                backCtx.drawImage(video, 0, 0, video.width, video.height);
            }

            var log = document.getElementById('log');
            var weight = [1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9, 1/9]
            // var weight = [1, 0, 0, 0, 1, 0, 0, 0, 1]
            function update() {
                Stats.calculate(log);
                requestAnimFrame(update);

                getVideoFrame();                

                // some freaky functions
                // var pixels = backCtx.getImageData(0, 0, backCanvas.width, backCanvas.height);
                // var frame = Cv.convolute(pixels, weight, false);
                // backCtx.putImageData(frame, 0, 0);
                var rBounds = BlobDetector.detect(35, 50);
                // var bBounds = BlobDetector.detect(185, 210);
                // var gBounds = BlobDetector.detect(90, 105);

                frame = backCtx.getImageData(0, 0, canvas.width, canvas.height)
                ctx.putImageData(frame, 0, 0);

                //Draw result
                ctx.save();
                ctx.fillStyle = 'red';
                ctx.fillRect(Math.floor(rBounds.x),Math.floor(rBounds.y), 5, 5);
                // ctx.strokeStyle = 'blue';
                // ctx.strokeRect(50 * Math.float(bBounds.x/50), 50 * Math.float(bBounds.y/50), 50, 50);
                // ctx.strokeStyle = 'green';
                // ctx.strokeRect(gBounds.x, gBounds.y, 50, 50);
                ctx.restore();
            }
        </script>
    </body>
</html>